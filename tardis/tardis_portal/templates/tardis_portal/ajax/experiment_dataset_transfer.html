{% if experiments %}
<form id="other-experiment-selection" class="form-horizontal">
  <fieldset>
    <div class="control-group">
      <label class="control-label" for="input01">Experiment</label>
      <div class="controls">
        <select name="experiment_id">
          {% for experiment in experiments %}
          <option value="{{experiment.id}}">
            {{experiment.title}}{% if experiment.locked %} (locked){% endif %}
          </option>
          {% endfor %}
        </select>
      </div>
    </div>
  </fieldset>
</form>

<p class="help-text" id="transfer_help">Help!</p>

<div id="other-experiment-datasets"></div>

<script type="text/javascript">
var otherDatasetTiles;
(function() {

  function getDatasetsForExperiment(experimentId, locked) {
    var datasets = new MyTardis.Datasets();
    datasets.experimentId = parseInt(experimentId),
    {# Careful! Remember Django replaces this first! #}
    // Substitute experiment ID to get collection
    datasets.url = Mustache.to_html("{{ url_pattern }}",
        { 'experiment_id': experimentId });

    var datasetTiles = new MyTardis.DatasetTiles({
      'id': "other-experiment-datasets",
      'collection': datasets,
      'el': $('#other-experiment-datasets').get(0)
    });

    datasets.fetch({});
    var help = '<p class="help-text" id="transfer_help">' +
      '<strong>Instructions:</strong> ' +
      'Select an transfer Experiment from the list above. ' +
      {% if not experiment.locked %}
        'Drag a Dataset right to add it to the current Experiment. ' +
      {% endif %}
      (locked ? '' : 
        'Drag a Dataset left to add it to the transfer Experiment. ') +
      'Click the "X" to remove a Dataset from an Experiment.</p>';

    $('[id="transfer_help"]').html(help);
    return datasetTiles;
  }

  $('form#other-experiment-selection').submit(function(evt) {
    evt.preventDefault();
    var experimentId = $(this).find('[name="experiment_id"]').val();
    var text = $(this).find('[name="experiment_id"] option:selected').text();
    var locked = /\(locked\)/.test(text);
    otherDatasetTiles = getDatasetsForExperiment(experimentId, locked);
  });
  $('form#other-experiment-selection select').change(function(evt) {
    $(this).parents('form').submit();
  });

  // Load initial data
  $('form#other-experiment-selection').submit();
})();
</script>

{% else %}
<div class="alert">
  <p>You do not currently own any other experiments.</p>
</div>
{% endif %}
